"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const node_server_1=require("@hono/node-server"),hono_1=require("hono"),node_telegram_bot_api_1=__importDefault(require("node-telegram-bot-api")),dotenv_1=__importDefault(require("dotenv")),sharp_1=__importDefault(require("sharp")),node_fetch_1=__importDefault(require("node-fetch")),constants_1=require("./constants");dotenv_1.default.config();const port=3e3,token=process.env.TOKEN,app=new hono_1.Hono,bot=new node_telegram_bot_api_1.default(token,{polling:!0});let chosenFormat="";const sendFormatSelection=e=>{bot.sendMessage(e,constants_1.arabicLanguage.chooseFormat,{reply_markup:{inline_keyboard:constants_1.supportedFormats.map((e=>[{text:e.toUpperCase(),callback_data:e}]))}})};bot.on("text",(e=>{const o=e.chat.id;sendFormatSelection(o),chosenFormat=""})),bot.onText(/\/help/,(e=>{const o=e.chat.id;bot.sendMessage(o,constants_1.arabicLanguage.help)})),bot.on("callback_query",(e=>{const o=e.message;chosenFormat=e.data,bot.sendMessage(o.chat.id,`اخترت ${null==chosenFormat?void 0:chosenFormat.toUpperCase()} ✅\nارسل الصورة 📷`)})),bot.on("photo",(async e=>{var o,t;const a=e.chat.id;if(!chosenFormat)return bot.sendMessage(a,"الرجاء اختيار الصيغة أولا ❗️"),void sendFormatSelection(a);bot.sendMessage(a,`نعمل على تغيير صورتك إلى ${chosenFormat.toUpperCase()} \n انتظر قليلا ⏳`);const n=null===(t=null===(o=e.photo)||void 0===o?void 0:o[e.photo.length-1])||void 0===t?void 0:t.file_id;try{const e=await bot.getFileLink(n),o=await(0,node_fetch_1.default)(e);if(!o.ok)throw new Error(`Failed to fetch image (${o.status} ${o.statusText})`);const t=await o.arrayBuffer(),r=Buffer.from(t),s=chosenFormat,c=await(0,sharp_1.default)(r).toFormat(s,{quality:100}).toBuffer();bot.sendDocument(a,c),bot.sendMessage(a,`تفضل صورتك بصيغة ${chosenFormat.toUpperCase()} 🖼️\nلو احتجت شيئا آخر فأرسل نقطة\nللتواصل: x.com/alwalxed`),chosenFormat=""}catch(e){bot.sendMessage(a,"An error occurred while converting your image. Please try again."),console.error("Error converting image:",e)}})),(0,node_server_1.serve)({fetch:app.fetch,port:3e3}),console.log("Server is running on port 3000");