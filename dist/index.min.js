"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var a=Object.getOwnPropertyDescriptor(t,o);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,a)}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const node_server_1=require("@hono/node-server"),hono_1=require("hono"),node_telegram_bot_api_1=__importDefault(require("node-telegram-bot-api")),dotenv=__importStar(require("dotenv")),sharp_1=__importDefault(require("sharp")),constants_1=require("./constants");dotenv.config();const port=3e3,token=process.env.TOKEN,app=new hono_1.Hono,bot=new node_telegram_bot_api_1.default(token,{polling:!0}),userState=new Map,sendFormatSelection=e=>{bot.sendMessage(e,constants_1.arabicLanguage.chooseFormat,{reply_markup:{inline_keyboard:constants_1.supportedFormats.map((e=>[{text:e.toUpperCase(),callback_data:e}]))}})};bot.on("text",(e=>{const t=e.chat.id;sendFormatSelection(t),userState.set(t,{})})),bot.onText(/\/help/,(e=>{const t=e.chat.id;bot.sendMessage(t,constants_1.arabicLanguage.help)})),bot.on("callback_query",(e=>{const t=e.message.chat.id,o=e.data;userState.set(t,{chosenFormat:o}),bot.sendMessage(t,`اخترت ${null==o?void 0:o.toUpperCase()} ✅\nارسل الصورة 📷`)})),bot.on("photo",(async e=>{var t,o;const r=e.chat.id,a=userState.get(r);if(!a||!a.chosenFormat)return bot.sendMessage(r,"الرجاء اختيار الصيغة أولا ❗️"),void sendFormatSelection(r);bot.sendMessage(r,`نعمل على تغيير صورتك إلى ${a.chosenFormat.toUpperCase()} \n انتظر قليلا ⏳`);const n=null===(o=null===(t=e.photo)||void 0===t?void 0:t[e.photo.length-1])||void 0===o?void 0:o.file_id;try{const e=await bot.getFileLink(n),t=await fetch(e);if(!t.ok)throw new Error(`فشل في جلب الصورة (${t.status} ${t.statusText})`);const o=await t.arrayBuffer(),s=Buffer.from(o),i=a.chosenFormat,c=await(0,sharp_1.default)(s).toFormat(i,{quality:100,compressionLevel:0}).toBuffer();bot.sendDocument(r,c),bot.sendMessage(r,`تفضل صورتك بصيغة ${a.chosenFormat.toUpperCase()} 🖼️\nلو احتجت شيئا آخر فأرسل نقطة\nللتواصل: x.com/alwalxed`),userState.set(r,{})}catch(e){bot.sendMessage(r,"حدث خطأ أثناء تحويل صورتك. الرجاء المحاولة مرة أخرى."),console.error("خطأ في تحويل الصورة:",e)}})),(0,node_server_1.serve)({fetch:app.fetch,port:3e3}),console.log("الخادم يعمل على المنفذ 3000");